# 영속성 컨텍스트란?

- 엔티티를 영구 저장하는 환경
- 애플리케이션과 데이터베이스 사이에서 객체를 보관하는 가상의 데이터베이스 같은 역할을 한다.
- 엔티티 매니저를 통해 엔티티를 저장하거나 조회하면 엔티티 매니저는 영속성 컨텍스트에 엔티티를 보관하고 관리한다.


### 영속성 컨텍스트의 특징

- 엔티티 매니저를 생성할 때 하나 만들어진다.
- 엔티티 매니저를 통해서 영속성 컨텍스트에 접근하고 관리할 수 있다.
- 영속성 컨텍스트는 엔티티를 식별자 값으로 구분한다. 따라서 영속 상태는 식별자 값이 반드시 있어야 한다.
- JPA는 보통 트랜잭션을 커밋하는 순간 영속성 컨텍스트에 새로 저장된 엔티티를 데이터 베이스에 반영하는데 이를 flush라고 한다.

### 엔티티의 생명주기

- 비영속
  - 영속성 컨텍스트와 전혀 관계가 없는 상태
  - 엔티티 객체를 생성했지만 아직 영속성 컨텍스트에 저장하지 않은 상태를 비영속이라 한다.

```
Member member = new Member();
```

- 영속
  - 영속성 컨텍스트에 저장된 상태
  - 엔티티 매니저를 통해서 엔티티를 영속성 컨텍스트에 저장한 상태를 말하며 영속성 컨텍스트에 의해 관리된다는 뜻이다.

```
em.persist(member);
```

- 준영속
  - 영속성 컨텍스트에 저장되었다가 분리된 상태
  - 영속성 컨텍스트가 관리하던 영속 상태의 엔티티를 더이상 관리하지 않으면 준영속 상태가 된다.
  - 1차 캐시, 쓰기 지연, 변경 감지, 지연 로딩을 포함한 영속성 컨텍스트가 제공하는 어떠한 기능도 동작하지 않는다.
  - 식별자 값을 가지고 있다.

```
// 엔티티를 영속성 컨텍스트에서 분리해 준영속 상태로 만든다.
em.detach(member);
// 영속성 콘텍스트를 비워도 관리되던 엔티티는 준영속 상태가 된다.
em.claer();
// 영속성 콘텍스트를 종료해도 관리되던 엔티티는 준영속 상태가 된다.
em.close();
```

- 삭제
    - 삭제된 상태
    - 엔티티를 영속성 컨텍스트와 데이터베이스에서 삭제한다.
```
em.remove(member);
```

## 영속성 컨텍스트의 장점
1. 1차 캐시
- 영속성 컨텍스트 내부에는 캐시가 있는데 이를 1차 캐시라고 한다.
- 영속 상태의 엔티티를 이곳에 저장한다.
- 1차 캐시의 키는 식별자 값(데이터베이스의 기본 키)이고 값은 엔티티 인스턴스이다.

2. 동일성보장
- 영속성 컨텍스트는 엔티티의 동일성을 보장한다.
- 동일성 비교 : 실제 인스턴스가 같다. ==을 사용해 비교한다.

3. 트랜잭션을 지원하는 쓰기 지연
- 엔티티 매니저는 트랜잭션을 커밋하기 직전까지 내부 쿼리 저장소에 INSERT SQL을 모아둔다. 
- 그리고 트랜잭션을 커밋할 때 모아둔 쿼리를 DB에 보낸다. 
- 이것을 트랜잭션을 지원하는 쓰기 지연이라 한다.

4. 변경 감지
- JPA로 엔티티를 수정할 때는 단순히 엔티티를 조회해서 데이터를 변경하면 된다.
    - 영속성 컨텍스트는 commit으로 flush가 실행되면 변경사항들을 체크해 update를 해준다. 
    - 체크하는 방식은 영속성 컨텍스트에 들왔을 최초의 모습을 스냅샷으로 떠놓고, 그 후 flush 할 때 실제 entity와 스냅샷을 비교해서 달라진 것을 감지한다.
- 변경 감지는 영속성 컨텍스트가 관리하는 영속 상태의 엔티티만 적용된다.

5. 지연 로딩
- 엔티티와 관계가 맺어진 엔티티의 데이터를 가져올 수 있다.
